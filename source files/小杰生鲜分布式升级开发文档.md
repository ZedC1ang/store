## 分布式锁

- 什么是分布式锁：分布式环境下的锁
- 使用场景：多个服务操作同一个共享资源

### Redis实现分布式锁

- 获取锁的本质：获得标记位
- setnx：原子性
- 删除即释放
- 同一流程：客户端A -> setnx成功，获取锁成功 -> Redis
- 同一流程：客户端B -> setnx失败，获取锁失败 -> Redis

### 过期时间

- 不设置过期时间的风险：假设客户端A在拿到锁之后，突然死机了，没法释放锁，其它的客户端B、C将永远无法获得锁。

### Zookeeper实现分布式锁

- 临时顺序节点：有序，顺序自增
- Watch机制：事件监听器
- 创建顺序节点，判断是否是最小
- 最小代表获取成功，执行完业务逻辑后删除节点
- 非最小则等待被上个节点唤醒
- 以此类推不断传递锁

## RabbitMQ应用

- RabbitMQ的设计模式——生产者消费者模式

### RabbitMQ的设计模式

- BlockingQueue

### 项目实操：用MQ实现对库存的返还

- 取消订单，返还库存
- 单体里可以直接调用mapper实现
- 微服务则使用MQ