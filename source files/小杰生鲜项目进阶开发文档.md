## Spring Cloud电商进阶开发

1. 定时任务：批量关闭订单
2. 性能与安全性提升：线程池和ThreadLocal的应用、Zuul安全性增强
3. 新技术应用：Spring Cloud Gateway

## 定时任务

- 使用场景
- 定时任务的实现——CRON表达式
- 定时任务在Spring中的应用：@Scheduled、定期取消超时订单

### 定时任务——使用场景

- 更新、处理数据

### 如何定时？CRON表达式

- Cron表达式是一个字符串，字符串以5个空格隔开，分开6个域，每一个域代表一个含义
- 第一位，表示秒，取值0-59
- 第二位，表示分，取值0-59
- 第三位，表示小时，取值0-23
- 第四位，日期天/日，取值1-31
- 第五位，日期月份，取值1-12
- 第六位，星期，取值0-6
- (*)星号：“每”
- (?)问好：这个位置的值不确定
- (-)减号：表达一个范围
- (,)逗号：表达一个列表值
- (/)斜杠：如：x/y，x是开始值，y是步长，比如在第一位（秒）0/15就是，从0秒开始，每15秒，最后就是0，15，30，45，60
  另：*/y，等同于0/y
- 0 0 3 * * ?：每天3点执行
- 0 5/10 3 * * ?：每天3点的 5分，15分，25分，35分，45分，55分这几个时间点执行

### 代码实操：定时任务在Spring中的应用

- 使用@Scheduled注解实现定时任务
- 用定时任务实现查询超时未付款订单并自动取消
- 加分布式锁：防止资源浪费和数据出错

## 安全性提升

### 代码实操：Zuul安全性增强

- 屏蔽接口转发（不能对外暴露Feign接口）

- 异常统一处理：通过@ComponentScan把相关的包引入进来

## 新技术应用：Spring Cloud Gateway

### 实操：开发Spring-Cloud-Gateway

- 初始化并跑通项目
- 实现转发
- 配置自定义前缀
- 过滤器：旧版本架构使用的Redis共享Session，升级Gateway后需要使用过滤器并改动Session相关代码
  步骤如下：
  1. 去除pom里面和session相关的依赖
  2. 去除启动类中@EnableRedisHttpSession注解
  3. 去除配置文件中与session相关的内容
  4. 每个主模块中配置user过滤器以获取信息以及鉴权相关内容
  5. 更改controller中与session相关的代码，改造成Threadlocal
  6. UserFeign升级，使用UserInfoFilter获取user信息
  7. 去除其他模块的包，升级Gateway网关架构后，不再需要引入其他模块的包，减少耦合程度
- 实现身份验证
- 排除不需要转发的地址
- UserFeign升级
- 全流程测试

## 项目面试

- 项目架构

![项目业务架构图](G:\Program Files\Java\Project\store\source files\项目业务架构图.png)

- 架构演进：单体变微服务、用户权限校验升级、网关升级
- 项目亮点：线程池、分布式锁、分布式事务

### 架构演进

- 单体变微服务：Spring Boot -> Spring Cloud
- 用户权限校验升级：传统的Session和Cookie模式 -> JWT的验证方式
- 网关升级：Zuul网关 -> Spring Cloud Gateway网关(如何定义过滤器、如何在新网关下进行身份验证、如何把Session排除掉并升级UserFeign)

### 项目亮点

- 线程池：Cron表达式
- 分布式锁：使用定时任务的时候，为了防止多个实例同时执行，故使用分布式锁(Redis-Redisson实现)
- 分布式事务：正是因为有了架构升级，有了微服务的拆解，导致原本的单机事务不能满足我们的现在的需求，所以使用了分布式事务